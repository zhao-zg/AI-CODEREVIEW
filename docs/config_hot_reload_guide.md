# AI-CodeReview 配置热重载功能使用指南

## 功能概述

配置热重载功能允许您在不重启服务的情况下使配置更改立即生效，大大提升了配置管理的便利性和效率。

## 主要特性

### 🔄 自动配置重载
- **实时监控**: 自动监控配置文件变化
- **智能重载**: 配置更改后自动通知相关服务
- **防抖机制**: 避免频繁重载导致的性能问题

### 🎯 立即生效
- **环境变量**: 立即重新加载 `.env` 文件
- **服务通知**: 自动通知 API 和 Worker 进程
- **UI更新**: 界面配置实时更新
- **⏰ 定时任务**: 自动重新配置定时任务（cron表达式、检查间隔等）

### 🧪 配置验证
- **连接测试**: 验证 AI 模型、数据库等配置
- **服务状态**: 实时检查各服务运行状态
- **错误提示**: 详细的错误信息和修复建议

## 使用方法

### 1. 通过 UI 界面（推荐）

#### 步骤 1: 进入配置页面
1. 打开 AI-CodeReview 仪表板
2. 点击左侧菜单的 "⚙️ 系统配置"

#### 步骤 2: 修改配置
1. 在 "📝 配置管理" 标签页中修改需要的配置项
2. 点击 "💾 保存配置" 按钮

#### 步骤 3: 自动生效
- 系统会自动保存配置并尝试立即应用
- 如果成功，会显示 "🎉 配置已立即生效！"
- 如果部分成功，会提示哪些服务可能需要重启

#### 步骤 4: 验证配置（可选）
1. 点击 "🧪 测试当前配置" 按钮验证配置有效性
2. 点击 "📊 检查服务状态" 查看各服务运行状态
3. 点击 "🔄 立即重载配置" 手动触发配置重载

### 2. 手动配置重载

#### 方法 1: API 端点
```bash
# 通过 API 端点触发配置重载
curl -X POST http://localhost:5001/reload-config
```

#### 方法 2: 命令行工具
```bash
# 使用配置重载工具
python biz/utils/config_reloader.py

# 启动配置监控服务
python scripts/config_monitor.py
```

#### 方法 3: 信号通知
```bash
# 发送信号给 API 进程
kill -USR1 <api_pid>

# 发送信号给 Worker 进程
kill -USR1 <worker_pid>
```

### 3. 自动监控模式

#### 启动配置监控服务
```bash
# 在后台启动配置监控
python scripts/config_monitor.py &

# 或者作为服务运行
nohup python scripts/config_monitor.py > config_monitor.log 2>&1 &
```

监控服务会自动：
- 监听 `conf/` 目录下的文件变化
- 检测到变化后自动重载配置
- 通知相关服务更新配置

## 支持的配置类型

### ✅ 立即生效的配置
- **AI 模型配置**: API 密钥、模型参数等
- **消息推送配置**: 钉钉、企业微信、飞书等
- **平台开关**: GitLab、GitHub、SVN 启用状态
- **日志级别**: 系统日志输出级别
- **审查参数**: 审查风格、最大 token 数等

### ⚠️ 需要重启的配置
- **端口配置**: API 服务端口更改
- **队列驱动**: 从内存队列切换到 Redis 队列
- **数据库连接**: 数据库地址更改

### 📋 配置文件支持
- `.env` - 环境变量配置
- `dashboard_config.py` - 仪表板配置
- `prompt_templates.yml` - 提示模板配置

## 故障排除

### 配置重载失败
1. **检查文件权限**: 确保配置文件可读写
2. **检查服务状态**: 使用 "📊 检查服务状态" 功能
3. **查看日志**: 检查 `log/app.log` 中的错误信息
4. **手动重启**: 如果热重载失败，考虑重启相关服务

### 服务无响应
1. **检查进程**: 使用 `ps aux | grep python` 查看进程
2. **检查端口**: 使用 `netstat -tuln | grep 5001` 检查端口占用
3. **重启服务**: 重启 Docker 容器或相关进程

### 配置不生效
1. **验证配置**: 使用 "🧪 测试当前配置" 功能
2. **检查语法**: 确保配置文件语法正确
3. **清除缓存**: 重启浏览器或清除缓存
4. **强制重载**: 使用 "🔄 立即重载配置" 功能

## 最佳实践

### 🎯 配置管理
1. **备份配置**: 重要配置更改前先备份
2. **分步测试**: 逐步修改配置并测试
3. **监控日志**: 关注配置重载的日志输出

### 🔒 安全考虑
1. **敏感信息**: API 密钥等敏感信息仅在界面中显示部分
2. **权限控制**: 确保配置文件的访问权限正确
3. **定期审查**: 定期检查配置的有效性和安全性

### ⚡ 性能优化
1. **避免频繁更改**: 批量修改配置而非逐个更改
2. **监控资源**: 注意配置重载对系统性能的影响
3. **合理使用**: 非必要时避免频繁触发重载

## 技术原理

### 配置监控机制
```
文件变化 → 监控器检测 → 防抖处理 → 配置重载 → 服务通知
```

### 服务通知方式
1. **信号通知**: 向进程发送 SIGUSR1 信号
2. **API 调用**: 通过 HTTP 端点触发重载
3. **文件标记**: 通过文件标记通知 UI 服务

### 重载流程
1. 重新加载环境变量文件
2. 更新进程内的配置变量
3. 通知相关服务组件
4. 验证配置有效性
5. 返回重载结果

## 定时任务热重载

### ⏰ 支持的定时任务配置

修改以下配置后，**无需重启服务即可生效**：

| 配置项 | 说明 | 示例 |
|-------|------|------|
| `REPORT_CRONTAB_EXPRESSION` | 工作日报发送时间 | `0 18 * * 1-5` |
| `SVN_CHECK_CRONTAB` | SVN全局检查间隔 | `*/30 * * * *` |
| `check_crontab`（仓库级） | 单个仓库检查间隔 | `0 */5 * * * *` |

### 🔄 重载流程

1. **修改cron配置**：编辑 `.env` 文件中的定时表达式
2. **触发重载**：
   - 自动：保存文件后等待几秒（如启用文件监控）
   - 手动：通过UI点击"🔄 立即重载配置"或调用 `/reload-config` 接口
3. **系统处理**：
   - 移除所有旧的定时任务
   - 重新解析cron表达式
   - 重新添加定时任务
4. **验证生效**：查看日志确认新的定时任务已配置

### 📝 示例：修改SVN检查间隔

```bash
# 1. 编辑配置文件
nano conf/.env

# 2. 修改检查间隔（从30分钟改为10分钟）
SVN_CHECK_CRONTAB=*/10 * * * *

# 3. 触发重载
curl -X POST http://localhost:5001/reload-config

# 4. 查看日志确认
tail -f log/app.log | grep "定时任务"

# 输出示例：
[INFO] 🔄 检测到调度器正在运行，正在重新配置定时任务...
[INFO] 已移除 3 个旧的定时任务
[INFO] ✅ SVN全局定时任务已配置: */10 * * * *
[INFO] ✅ 已重新配置 3 个定时任务
```

### ⚠️ 注意事项

- ⏱️ 定时任务重新配置耗时约 200-600ms
- ✅ 不会影响正在执行的任务
- ✅ 不会丢失检查点或审查记录
- ❌ cron表达式格式错误会导致重载失败

详见：[Cron表达式使用指南](./cron_expression_guide.md)、[定时任务并发控制](./concurrent_control_guide.md)

---

## 注意事项

- 某些配置更改（如端口、数据库连接）仍需要重启服务
- 配置重载可能有2-3秒的延迟
- 定时任务重新配置耗时约200-600ms（取决于任务数量）
- 在高并发环境下使用时需要注意性能影响
- 建议在生产环境中先在测试环境验证配置更改

## 支持与反馈

如果在使用过程中遇到问题或有改进建议，请：
1. 查看系统日志获取详细错误信息
2. 使用内置的诊断工具进行故障排除
3. 在 GitHub 项目中提交 Issue 或反馈
