# Docker é…ç½®æ–‡ä»¶è‡ªåŠ¨å¤åˆ¶æŒ‡å—

## ğŸ¯ æ¦‚è¿°

AI-CodeReview é¡¹ç›®ç°åœ¨æ”¯æŒ Docker é…ç½®æ–‡ä»¶çš„æ™ºèƒ½è‡ªåŠ¨å¤åˆ¶å’Œç®¡ç†ã€‚é€šè¿‡æ˜ å°„ `conf` ç›®å½•ï¼Œæ‚¨å¯ä»¥å®ç°é…ç½®çš„æŒä¹…åŒ–å’Œçµæ´»ç®¡ç†ã€‚

## ğŸ”§ æ ¸å¿ƒæœºåˆ¶

### 1. è‡ªåŠ¨é…ç½®åˆå§‹åŒ–

å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œ `scripts/docker_init.py` è„šæœ¬ï¼Œè¯¥è„šæœ¬ä¼šï¼š

- âœ… **æ£€æŸ¥å¿…è¦é…ç½®æ–‡ä»¶** - ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„é…ç½®æ–‡ä»¶éƒ½å­˜åœ¨
- âœ… **è‡ªåŠ¨åˆ›å»ºé»˜è®¤é…ç½®** - ä» `.env.dist` åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- âœ… **åŠ è½½ç¯å¢ƒå˜é‡** - è‡ªåŠ¨åŠ è½½ `.env` æ–‡ä»¶ä¸­çš„é…ç½®
- âœ… **é…ç½® supervisord** - æ ¹æ®è¿è¡Œæ¨¡å¼è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„ supervisord é…ç½®
- âœ… **éªŒè¯å…³é”®é…ç½®** - æ£€æŸ¥é‡è¦é…ç½®é¡¹æ˜¯å¦æ­£ç¡®è®¾ç½®

### 2. é…ç½®æ–‡ä»¶æ˜ å°„

é€šè¿‡åœ¨ Docker Compose ä¸­æ˜ å°„ `conf` ç›®å½•ï¼š

```yaml
volumes:
  - ./conf:/app/conf
```

å¯ä»¥å®ç°ï¼š
- ğŸ“ **é…ç½®æŒä¹…åŒ–** - é…ç½®æ›´æ”¹åœ¨å®¹å™¨é‡å¯åä¿ç•™
- ğŸ”„ **åŒå‘åŒæ­¥** - ä¸»æœºå’Œå®¹å™¨é—´çš„é…ç½®æ–‡ä»¶è‡ªåŠ¨åŒæ­¥
- âš™ï¸ **çµæ´»ç®¡ç†** - å¯ä»¥ç›´æ¥åœ¨ä¸»æœºä¸Šç¼–è¾‘é…ç½®æ–‡ä»¶

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ Docker Composeï¼ˆæ¨èï¼‰

1. **å¤åˆ¶ç¤ºä¾‹é…ç½®**
   ```bash
   cp docker-compose.example.yml docker-compose.yml
   ```

2. **åˆ›å»ºé…ç½®ç›®å½•**
   ```bash
   mkdir -p conf data log
   ```

3. **å¯åŠ¨æœåŠ¡**
   ```bash
   docker-compose up -d
   ```

### æ–¹å¼äºŒï¼šä½¿ç”¨ Docker å‘½ä»¤

```bash
# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p conf data log

# è¿è¡Œåº”ç”¨å®¹å™¨
docker run -d \
  --name ai-codereview \
  -p 5001:5001 -p 5002:5002 \
  -v $(pwd)/conf:/app/conf \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/log:/app/log \
  -e DOCKER_RUN_MODE=app \
  ai-codereview:latest
```

## ğŸ“ é…ç½®æ–‡ä»¶ç»“æ„

æ˜ å°„åçš„ `conf` ç›®å½•åŒ…å«ä»¥ä¸‹é‡è¦æ–‡ä»¶ï¼š

```
conf/
â”œâ”€â”€ .env                      # ç¯å¢ƒå˜é‡é…ç½®ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ .env.dist                 # ç¯å¢ƒå˜é‡æ¨¡æ¿ï¼ˆå†…ç½®é»˜è®¤å€¼ï¼‰
â”œâ”€â”€ dashboard_config.py       # ä»ªè¡¨æ¿é…ç½®
â”œâ”€â”€ prompt_templates.yml      # AI æç¤ºæ¨¡æ¿é…ç½®
â”œâ”€â”€ supervisord.app.conf      # åº”ç”¨æœåŠ¡é…ç½®
â””â”€â”€ supervisord.worker.conf   # å·¥ä½œæœåŠ¡é…ç½®
```

## âš™ï¸ é…ç½®ä¼˜å…ˆçº§

é…ç½®å€¼çš„åŠ è½½ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

1. **Docker ç¯å¢ƒå˜é‡** - é€šè¿‡ `-e` å‚æ•°æˆ– `environment` é…ç½®çš„å˜é‡
2. **conf/.env æ–‡ä»¶** - æ˜ å°„ç›®å½•ä¸­çš„ç¯å¢ƒé…ç½®æ–‡ä»¶
3. **conf/.env.dist** - å†…ç½®çš„é»˜è®¤é…ç½®æ¨¡æ¿
4. **ä»£ç é»˜è®¤å€¼** - ç¨‹åºä¸­çš„å¤‡ç”¨é»˜è®¤å€¼

## ğŸ” é…ç½®éªŒè¯

å®¹å™¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨éªŒè¯ä»¥ä¸‹å…³é”®é…ç½®ï¼š

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `LLM_PROVIDER` | å¤§è¯­è¨€æ¨¡å‹æä¾›å•† | `deepseek` |
| `SERVER_PORT` | æœåŠ¡ç«¯å£ | `5001` |
| `LOG_LEVEL` | æ—¥å¿—çº§åˆ« | `INFO` |
| `DASHBOARD_USER` | ä»ªè¡¨æ¿ç”¨æˆ·å | `admin` |
| `DASHBOARD_PASSWORD` | ä»ªè¡¨æ¿å¯†ç  | `admin` |

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é…ç½®æ–‡ä»¶ç®¡ç†

```bash
# ç¬¬ä¸€æ¬¡å¯åŠ¨åï¼Œé…ç½®æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ›å»º
docker-compose up -d

# åœæ­¢æœåŠ¡
docker-compose down

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim conf/.env

# é‡å¯æœåŠ¡åº”ç”¨æ–°é…ç½®
docker-compose up -d
```

### 2. å®‰å…¨é…ç½®

```bash
# è®¾ç½®é€‚å½“çš„æ–‡ä»¶æƒé™
chmod 600 conf/.env

# ä¸è¦å°† .env æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
echo "conf/.env" >> .gitignore
```

### 3. å¤‡ä»½å’Œæ¢å¤

```bash
# å¤‡ä»½é…ç½®
tar -czf config-backup-$(date +%Y%m%d).tar.gz conf/

# æ¢å¤é…ç½®
tar -xzf config-backup-20241225.tar.gz
```

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šé…ç½®æ–‡ä»¶ä¸å­˜åœ¨

**ç—‡çŠ¶**ï¼šå®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œæç¤ºé…ç½®æ–‡ä»¶ç¼ºå¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥æ˜ å°„ç›®å½•æƒé™
ls -la conf/

# é‡æ–°åˆå§‹åŒ–é…ç½®
docker run --rm -v $(pwd)/conf:/app/conf ai-codereview:latest python /app/scripts/init_env.py
```

### é—®é¢˜ 2ï¼šé…ç½®æ›´æ”¹ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**ï¼šä¿®æ”¹ `.env` æ–‡ä»¶åé…ç½®æ²¡æœ‰ç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# é‡å¯å®¹å™¨ä»¥åº”ç”¨æ–°é…ç½®
docker-compose restart

# æˆ–è€…å¼ºåˆ¶é‡æ–°åˆ›å»ºå®¹å™¨
docker-compose up -d --force-recreate
```

### é—®é¢˜ 3ï¼šæƒé™é—®é¢˜

**ç—‡çŠ¶**ï¼šå®¹å™¨æ— æ³•åˆ›å»ºæˆ–è¯»å–é…ç½®æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# è®¾ç½®æ­£ç¡®çš„ç›®å½•æƒé™
sudo chown -R $(id -u):$(id -g) conf/ data/ log/
chmod -R 755 conf/ data/ log/
```

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰é…ç½®æ¨¡æ¿

æ‚¨å¯ä»¥ä¿®æ”¹ `conf/.env.dist` æ¥å®šåˆ¶é»˜è®¤é…ç½®ï¼š

```bash
# ç¼–è¾‘æ¨¡æ¿æ–‡ä»¶
vim conf/.env.dist

# é‡æ–°ç”Ÿæˆé…ç½®æ–‡ä»¶
rm conf/.env
docker-compose restart
```

### å¤šç¯å¢ƒéƒ¨ç½²

```yaml
# å¼€å‘ç¯å¢ƒ
version: '3.8'
services:
  ai-codereview-dev:
    build: .
    volumes:
      - ./conf/dev:/app/conf
    environment:
      - LOG_LEVEL=DEBUG

# ç”Ÿäº§ç¯å¢ƒ
version: '3.8'
services:
  ai-codereview-prod:
    image: ai-codereview:latest
    volumes:
      - ./conf/prod:/app/conf
    environment:
      - LOG_LEVEL=INFO
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹é…ç½®åˆå§‹åŒ–æ—¥å¿—

```bash
# æŸ¥çœ‹å®¹å™¨å¯åŠ¨æ—¥å¿—
docker-compose logs ai-codereview

# å®æ—¶è·Ÿè¸ªæ—¥å¿—
docker-compose logs -f ai-codereview
```

### é…ç½®å˜æ›´å®¡è®¡

```bash
# æŸ¥çœ‹é…ç½®æ–‡ä»¶ä¿®æ”¹å†å²
git log --oneline conf/.env

# æ¯”è¾ƒé…ç½®å·®å¼‚
diff conf/.env conf/.env.dist
```

## ğŸ‰ æ€»ç»“

é€šè¿‡æ˜ å°„ `conf` ç›®å½•ï¼ŒAI-CodeReview ç°åœ¨æä¾›äº†ï¼š

- ğŸ”„ **è‡ªåŠ¨é…ç½®å¤åˆ¶** - å¿…è¦æ–‡ä»¶è‡ªåŠ¨åˆ›å»ºå’Œå¤åˆ¶
- ğŸ“ **é…ç½®æŒä¹…åŒ–** - é…ç½®åœ¨å®¹å™¨é‡å¯åä¿ç•™
- âš™ï¸ **çµæ´»ç®¡ç†** - æ”¯æŒå¤–éƒ¨é…ç½®æ–‡ä»¶ç¼–è¾‘
- ğŸ›¡ï¸ **å®‰å…¨å¯é ** - é…ç½®éªŒè¯å’Œé”™è¯¯å¤„ç†
- ğŸ“Š **å®Œæ•´ç›‘æ§** - è¯¦ç»†çš„å¯åŠ¨æ—¥å¿—å’ŒçŠ¶æ€æ£€æŸ¥

è¿™ç§è®¾è®¡ç¡®ä¿äº† Docker éƒ¨ç½²çš„ä¾¿åˆ©æ€§å’Œé…ç½®ç®¡ç†çš„çµæ´»æ€§ï¼Œé€‚åˆå„ç§éƒ¨ç½²åœºæ™¯ã€‚
