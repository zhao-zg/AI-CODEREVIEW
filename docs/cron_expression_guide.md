# Cron 表达式使用指南

本系统支持**5段式**和**6段式** Cron 表达式，用于配置定时任务（如工作日报、SVN检查等）。

## 📋 Cron 表达式格式

### **5段式格式**（标准，不含秒）

```
分 时 日 月 周
```

| 字段 | 允许值 | 允许的特殊字符 | 说明 |
|------|--------|---------------|------|
| 分钟 | 0-59 | `* , - /` | 分钟 |
| 小时 | 0-23 | `* , - /` | 小时（24小时制） |
| 日期 | 1-31 | `* , - / L W` | 月份中的第几天 |
| 月份 | 1-12 | `* , - /` | 月份（1=1月，12=12月） |
| 星期 | 0-6 | `* , - / L #` | 星期几（0=周一，6=周日）<br>**注意**：APScheduler中0=周一 |

### **6段式格式**（含秒，支持更精确的定时）

```
秒 分 时 日 月 周
```

| 字段 | 允许值 | 允许的特殊字符 | 说明 |
|------|--------|---------------|------|
| 秒 | 0-59 | `* , - /` | 秒 |
| 分钟 | 0-59 | `* , - /` | 分钟 |
| 小时 | 0-23 | `* , - /` | 小时（24小时制） |
| 日期 | 1-31 | `* , - / L W` | 月份中的第几天 |
| 月份 | 1-12 | `* , - /` | 月份（1=1月，12=12月） |
| 星期 | 0-6 | `* , - / L #` | 星期几（0=周一，6=周日） |

---

## 🔤 特殊字符说明

| 字符 | 含义 | 示例 |
|------|------|------|
| `*` | 任意值 | `* * * * *` = 每分钟 |
| `,` | 列举值 | `0,15,30,45 * * * *` = 每小时的0、15、30、45分 |
| `-` | 范围值 | `0 9-17 * * 1-5` = 工作日9:00-17:00每小时整点 |
| `/` | 步长值 | `*/5 * * * *` = 每5分钟 |
| `L` | 最后 | `0 0 L * *` = 每月最后一天午夜 |
| `W` | 工作日 | `0 0 15W * *` = 离每月15号最近的工作日 |
| `#` | 第几个星期几 | `0 0 * * 1#1` = 每月第1个周一 |

---

## 📝 常用示例

### **5段式示例**（分钟级精度）

| Cron表达式 | 说明 |
|-----------|------|
| `0 18 * * 1-5` | 工作日（周一至周五）18:00 |
| `*/30 * * * *` | 每30分钟 |
| `0 */2 * * *` | 每2小时整点 |
| `0 9-17 * * 1-5` | 工作日9:00-17:00每小时整点 |
| `0,30 * * * *` | 每小时的0分和30分 |
| `0 0 * * *` | 每天午夜00:00 |
| `0 12 * * *` | 每天中午12:00 |
| `0 0 1 * *` | 每月1号00:00 |
| `0 0 * * 0` | 每周日00:00 |

### **6段式示例**（秒级精度）

| Cron表达式 | 说明 |
|-----------|------|
| `0 0 18 * * 1-5` | 工作日18:00:00 |
| `0 */5 * * * *` | 每5分钟整点（如10:00:00, 10:05:00） |
| `*/30 * * * * *` | 每30秒 |
| `0 0 */1 * * *` | 每1小时整点 |
| `0,30 * * * * *` | 每分钟的0秒和30秒 |
| `0 0 0 * * *` | 每天午夜00:00:00 |
| `0 0 9 * * 1-5` | 工作日早上9:00:00 |
| `*/10 * * * * *` | 每10秒 |
| `0 */15 * * * *` | 每15分钟整点 |

---

## ⚙️ 配置示例

### **环境变量配置（.env文件）**

```bash
# 5段式：工作日18:00发送日报
REPORT_CRONTAB_EXPRESSION=0 18 * * 1-5

# 6段式：工作日18:00:00发送日报
REPORT_CRONTAB_EXPRESSION=0 0 18 * * 1-5

# 5段式：每30分钟检查SVN
SVN_CHECK_CRONTAB=*/30 * * * *

# 6段式：每5分钟整点检查SVN
SVN_CHECK_CRONTAB=0 */5 * * * *

# 6段式：每30秒检查SVN（高频检查）
SVN_CHECK_CRONTAB=*/30 * * * * *
```

### **SVN多仓库配置（JSON格式）**

```json
{
  "SVN_REPOSITORIES": [
    {
      "name": "project1",
      "remote_url": "svn://example.com/repo1",
      "local_path": "data/svn/project1",
      "username": "user1",
      "password": "pass1",
      "check_crontab": "*/30 * * * *",  // 5段式：每30分钟
      "check_limit": 100
    },
    {
      "name": "project2",
      "remote_url": "svn://example.com/repo2",
      "local_path": "data/svn/project2",
      "username": "user2",
      "password": "pass2",
      "check_crontab": "0 */5 * * * *",  // 6段式：每5分钟整点
      "check_limit": 50
    },
    {
      "name": "high-freq-repo",
      "remote_url": "svn://example.com/repo3",
      "local_path": "data/svn/project3",
      "username": "user3",
      "password": "pass3",
      "check_crontab": "*/10 * * * * *",  // 6段式：每10秒
      "check_limit": 20
    }
  ]
}
```

---

## 🎯 使用建议

### **选择合适的精度**

| 场景 | 推荐格式 | 示例 | 说明 |
|------|---------|------|------|
| 日报发送 | 5段式 | `0 18 * * 1-5` | 分钟级精度足够 |
| 常规SVN检查 | 5段式 | `*/30 * * * *` | 每30分钟检查 |
| 高频SVN检查 | 6段式 | `0 */5 * * * *` | 每5分钟整点 |
| 测试/调试 | 6段式 | `*/10 * * * * *` | 每10秒执行 |

### **性能考虑**

- ⚠️ **秒级定时任务会增加系统负载**，建议仅在必要时使用
- ✅ **生产环境推荐使用5-10分钟以上的检查间隔**
- ✅ **测试环境可以使用更短的间隔（如30秒、1分钟）**
- ⚠️ **高频检查可能导致API限流或SVN服务器压力**

### **最佳实践**

```bash
# ✅ 推荐：生产环境
SVN_CHECK_CRONTAB=*/30 * * * *      # 每30分钟（5段式）
SVN_CHECK_CRONTAB=0 */10 * * * *    # 每10分钟整点（6段式）

# ⚠️ 谨慎使用：测试/调试环境
SVN_CHECK_CRONTAB=*/30 * * * * *    # 每30秒（6段式）
SVN_CHECK_CRONTAB=0 */1 * * * *     # 每1分钟整点（6段式）

# ❌ 不推荐：过高频率
SVN_CHECK_CRONTAB=*/10 * * * * *    # 每10秒（过于频繁）
SVN_CHECK_CRONTAB=*/5 * * * * *     # 每5秒（严重浪费资源）
```

---

## 🔧 验证和测试

### **验证cron表达式**

可以使用在线工具验证：
- [Crontab.guru](https://crontab.guru/)（5段式）
- [CronMaker](http://www.cronmaker.com/)（支持秒）

### **查看日志确认**

启动系统后，查看日志确认定时任务配置：

```bash
# 查看日志
tail -f log/app.log

# 看到类似输出表示成功：
[INFO] ✅ Cron schedule set (with seconds): second=0, minute=*/5, hour=*, day=*, month=*, day_of_week=*
[INFO] 为仓库 project1 创建独立定时任务（含秒），表达式: 0 */5 * * * *
```

---

## ❓ 常见问题

### **Q1: 支持秒级定时任务吗？**
✅ **支持！** 使用6段式cron表达式即可（如 `0 */5 * * * *` 表示每5分钟整点）。

### **Q2: 5段式和6段式可以混用吗？**
✅ **可以！** 系统会自动识别格式，不同任务可以使用不同的格式。

### **Q3: 如何设置每10秒执行一次？**
使用6段式：`*/10 * * * * *`

### **Q4: 为什么我的秒级任务没有生效？**
请检查：
1. 是否使用了6段式格式（含秒）
2. 日志中是否有错误提示
3. 是否重启了API服务

### **Q5: 最短可以设置多少秒？**
理论上支持 `* * * * * *`（每秒执行），但**强烈不推荐**，建议最短间隔10秒以上。

### **Q6: 如果上次检查还没结束，定时器又触发了怎么办？**
✅ **系统有完善的并发控制机制！**
- 使用**文件锁**防止重复执行
- 如果上次任务还在执行，新触发会**自动跳过**
- 日志会显示：`"已有检查任务正在执行，跳过本次触发"`
- 详见：[定时任务并发控制机制](./concurrent_control_guide.md)

### **Q7: 定时间隔设置得太短会怎样？**
⚠️ 如果定时间隔 < 实际执行时间，会出现大量"跳过"日志，但**不会重复执行**。
- 示例：每30秒触发，但实际需要5分钟 → 10次触发中只有1次会执行，其余9次都会跳过
- 建议：定时间隔 ≥ 实际执行时间

---

## 📚 参考资料

- [APScheduler官方文档](https://apscheduler.readthedocs.io/)
- [Cron表达式详解](https://en.wikipedia.org/wiki/Cron)
- [定时任务并发控制机制](./concurrent_control_guide.md)
- [项目配置指南](./configuration_guide.md)
